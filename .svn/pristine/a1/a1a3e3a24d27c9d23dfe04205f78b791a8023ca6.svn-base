<!--
程序名：问卷填写页面
功能：用户打开问卷链接对问卷进行填写
-->
<template>
  <div class="display">
    <div class="content">
      <h3>{{ title }}</h3>
      <div class="top" v-if="desc != null">
        {{ desc }}
      </div>
      <el-card class="box-card" :key="index" v-for="(item, index) in detail">
        <div slot="header" class="clearfix">
          <div class="questionTitle">
            <!--显示必填标识-->
            <span style="color: #F56C6C;">
              <span v-if="item.isMust">*</span>
              <span v-else>&nbsp;</span>
            </span>
            {{ index + 1 + "." + item.mainTitle }}
            <el-divider v-if="item.subtitile != null" content-position="left">{{
              item.subtitle
            }}</el-divider>
          </div>
        </div>

        <!--单选题展示-->
        <div
          class="text item"
          :key="index"
          v-for="(option, index) in item.options"
        >
          <div v-if="item.questionType == '2'">
            <el-radio
              v-model="item.answerOption"
              :label="index"
              style="margin: 5px;"
              >{{ option }}</el-radio
            >
          </div>
        </div>

        <!--多选题展示-->
        <el-checkbox-group
          v-if="item.questionType == '3'"
          v-model="item.answerOption"
        >
          <div
            class="text item"
            :key="option"
            v-for="(option, index) in item.options"
          >
            <el-checkbox :label="option" style="margin: 5px;">{{
              option
            }}</el-checkbox>
          </div>
        </el-checkbox-group>

        <!--填空题展示-->
        <el-input
          v-if="item.questionType == '1'"
          type="text"
          v-model="item.answerOption"
          resize="none"
        >
        </el-input>
      </el-card>
      <el-button
        type="primary"
        style="margin: 5px;"
        @click="submit"
        :loading="submitLoading"
        >{{ submitText }}</el-button
      >

      <div class="bottom">
        <el-link type="info" href="http://www.huashasoft.com/index.html"
          >郑州华砂信息信息技术有限公司&nbsp;提供技术支持</el-link
        >
      </div>
    </div>
  </div>
</template>
<script>
export default {
  data() {
    return {
      dialogShow: false,
      dialogTitle: "",
      dialogType: 1, //1添加 2修改
      oldItem: null, //编辑中问题的对象
      willAddQuestion: {
        //保存问卷问题信息
        paperSN: this.sn, //问卷SN
        questionType: "", //问题类型
        mainTitle: "", //问题主标题
        subtitle: "", //问题副标题
        option: [],
        options: [
          {
            title: ""
          }
        ],
        sortOrder: 1, //问题顺序
        isMust: false //是否必填
      },
      allType: [
        {
          value: "2",
          label: "单选题"
        },
        {
          value: "3",
          label: "多选题"
        },
        {
          value: "1",
          label: "填空题"
        }
        // {
        //   value: "4",
        //   label: "评分题"
        // }
      ],

      sn: "", //问卷SN
      title: "", //问卷标题
      desc: "", //问卷备注
      detail: [],
      startTimestamp: 0, //填写问卷开始时间戳 毫秒
      submitLoading: false, //提交按钮 加载中状态
      submitText: "提交" //提交按钮文字
    };
  },
  mounted() {
    var papersn = this.$route.params.sn;
    console.log(papersn);
    this.$axios.get(`/papers/${papersn}`).then(data => {
      let datas = data.data;
      if (datas.code == 200) {
        this.title = datas.data.queTitle;
        this.desc = datas.data.queDescribe;
        this.detail = datas.data.queQuestionEntities;
        this.detail.forEach(t => {
          if (this.isSelectQuestionType(t.questionType)) {
            if (t.options.length != null && t.options.length != 0) {
              t.options.shift();
            }
          }
        });
        document.title = datas.data.queTitle;
      } else {
        this.$message({
          type: "error",
          message: "获取失败，请重试"
        });
      }
    });
    this.startTimestamp = new Date().getTime(); //时间戳 毫秒
  },
  methods: {
    //提交问卷
    submit() {
      this.submitLoading = true;
      this.submitText = "提交中";
      var wjId = this.$route.params.sn;
      let useTime = parseInt(
        (new Date().getTime() - this.startTimestamp) / 1000
      ); //填写问卷用时 秒
      let answer = [];
      this.detail.forEach(t => {
        answer.push({
          questionTitle: t.mainTitle,
          paperSN: t.paperSN,
          questionSN: t.sn,
          answerOption: t.answerOption
        });
      });
      this.$axios.post("/answers", answer).then(data => {
        console.log(data);
        if (data.data.code == 200) {
          //提交成功
          this.submitLoading = false;
          this.submitText = "提交";
          this.$router.push({ path: "/thankyou" }); //跳到欢迎页
        } else {
          this.submitLoading = false;
          this.submitText = "提交";
          this.$notify.error({
            title: "错误",
            message: data.msg
          });
        }
      });
    },
    //判断是否为选择题
    isSelectQuestionType(questionType) {
      if (questionType == 2 || questionType == 3) {
        return true;
      }
      return false;
    }
  }
};
</script>
<style scoped>
.display {
  text-align: center;
  padding: 20px;
}
.display .top {
  color: #606266;
  padding: 0 10px 10px 10px;
  border-bottom: 3px solid #409eff;
  font-size: 15px;
  line-height: 22px;
  text-align: left;
}
.display .content {
  width: 100%;
  max-width: 800px;
  display: inline-block;
  text-align: center;
}
.display .box-card {
  text-align: left;
  width: 100%;
  margin: 10px 0 10px 0;
}
.display .bottom {
  margin: 20px 10px 20px 10px;
  color: #909399;
}
.display a:link,
a:visited,
a:active {
  color: #909399;
  text-decoration: none;
}
</style>
